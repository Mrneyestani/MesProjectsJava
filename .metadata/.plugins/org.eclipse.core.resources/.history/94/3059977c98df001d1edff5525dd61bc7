package fr.doranco.exemple.model.dao;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;

import fr.doranco.exemple.entity.CartePaiement;
import fr.doranco.exemple.model.connection.DataBaseConnection;
import fr.doranco.exemple.utils.Dates;

public class CarteDao implements ICartePaiementDao {

	@Override
	public int addCartePaiement(CartePaiement cartePaiement, int userId) throws Exception {
		
		Connection connection = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		int id = -1;
		try {
			connection = DataBaseConnection.getConnection();
			String requete = "INSERT INTO carte_paiement(numero_carte, date_validite, cryptogramme, user_id) " + "VALUES(?,?,?,?)";
			ps = connection.prepareStatement(requete, Statement.RETURN_GENERATED_KEYS);
			ps.setInt(1, cartePaiement.getNumeroCarte());
			ps.setDate(2, Dates.convertDateUtilToSql(cartePaiement.getDateValidite()));
			ps.setInt(3, cartePaiement.getCryptogramme());
			ps.setInt(4, userId);
			
			ps.executeUpdate();
			rs = ps.getGeneratedKeys();
			if (rs != null && rs.next()) {
				id = rs.getInt(1);
				cartePaiement.setId(id);
			}
		
		} finally {
			if (rs != null && !rs.isClosed()) {
				rs.close();
			}
			if (ps != null && !ps.isClosed()) {
				ps.close();
			}
			if (connection != null && !connection.isClosed()) {
				connection.close();
			}
		}
		return id;
	}

	@Override
	public CartePaiement getCartesPaiement(int id) throws Exception {
		
		Connection connection = null;
		PreparedStatement ps = null;
		ResultSet rs = null;
		CartePaiement cartePaiement = null;
		try {
			connection = DataBaseConnection.getConnection();
			String requete = "SELECT * FROM carte_paiement WHERE id = ?";
			ps = connection.prepareStatement(requete);
			ps.setInt(1, id);

			ps.execute();

			rs = ps.getResultSet();
			
			if (rs != null && rs.next()) {
				cartePaiement = new CartePaiement();
				cartePaiement.setId(rs.getInt("id"));
				cartePaiement.setNumeroCarte(rs.getInt("numero_carte"));
				cartePaiement.setDateValidite(Dates.convertDateSqlToUtil(rs.getDate("date_validite")));
				cartePaiement.setCryptogramme(rs.getInt("cryptogramme"));
			}
			

		} finally {
			if (rs != null && !rs.isClosed()) {
				rs.close();
			}
			if (ps != null && !ps.isClosed()) {
				ps.close();
			}
			if (connection != null && !connection.isClosed()) {
				connection.close();
			}
		}
		return cartePaiement;
	}

	@Override
	public void removeCartePaiement(int id) throws Exception {
		
		Connection connection = null;
		PreparedStatement ps = null;
		try {
			connection = DataBaseConnection.getConnection();
			String requete = "DELETE FROM carte_paiement WHERE id = ?";
			ps = connection.prepareStatement(requete);
			ps.setInt(1, id);

			ps.executeUpdate();

		} finally {
			if (ps != null && !ps.isClosed()) {
				ps.close();
			}
			if (connection != null && !connection.isClosed()) {
				connection.close();
			}
		}
		
	}

}
